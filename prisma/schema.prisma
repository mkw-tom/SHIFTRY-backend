generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  lineId    String   @unique
  name      String
  pictureUrl  String?
  role      UserRole
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  // M:N ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ãŒç®¡ç†ã™ã‚‹åº—èˆ—ï¼‰
  ownedStores OwnerStore[]
  // M:N ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ã¨ã—ã¦æ‰€å±ã™ã‚‹åº—èˆ—ï¼‰
  userStores  UserStore[]
  submittedShifts  SubmittedShift[]
}

enum UserRole {
  OWNER
  STAFF
}

model Store {
  id        String   @id @default(uuid())
  groupId   String   @unique
  storeId   String?   @unique @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  // M:Nï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ã¨ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  ownerStores OwnerStore[]

  // M:Nï¼ˆã‚¹ã‚¿ãƒƒãƒ•ã¨ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  userStores UserStore[]

  // ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿
  storeShifts StoreShift[]
  submittedShifts  SubmittedShift[]

}


// ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ã¨åº—èˆ—ã® M:N é–¢ä¿‚ï¼‰
model OwnerStore {
  ownerId String
  storeId String

  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@id([ownerId, storeId]) // è¤‡åˆä¸»ã‚­ãƒ¼
}

// ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ã¨åº—èˆ—ã® M:N é–¢ä¿‚ï¼‰
model UserStore {
  userId   String
  storeId  String

  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  store    Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@id([userId, storeId]) // è¤‡åˆä¸»ã‚­ãƒ¼
}

// ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿
// ç¢ºå®šã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆåº—èˆ—ç”¨ï¼‰
model StoreShift {
  id        String   @id @default(uuid())
  storeId   String
  weekStart DateTime
  weekEnd   DateTime? 
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  submittedShifts SubmittedShift[] @relation("StoreToSubmitted")

}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æå‡ºã‚·ãƒ•ãƒˆ
model SubmittedShift {
  id          String   @id @default(uuid())
  userId      String    
  storeId     String   
  shifts      Json    
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // ğŸ”¥ ä¿®æ­£ï¼šstore ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã« `map` ã‚’è¿½åŠ ã—ã¦ã€å¤–éƒ¨ã‚­ãƒ¼åã‚’æ˜ç¤ºçš„ã«è¨­å®š
  store       Store      @relation(fields: [storeId], references: [id], onDelete: Cascade, map: "SubmittedShift_storeId_store_fkey")
  
  // ğŸ”¥ ä¿®æ­£ï¼šstoreShift ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚‚ `map` ã‚’è¿½åŠ ã—ã¦ã€åˆ¥ã®å¤–éƒ¨ã‚­ãƒ¼åã‚’è¨­å®š
  storeShift  StoreShift @relation("StoreToSubmitted", fields: [storeId], references: [id], onDelete: Cascade, map: "SubmittedShift_storeId_storeShift_fkey")

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, storeId]) // âœ… 1ãƒ¦ãƒ¼ã‚¶ãƒ¼1åº—èˆ—ã«ã¤ã1ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿
}
